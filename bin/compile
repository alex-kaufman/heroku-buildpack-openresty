#!/bin/sh

BUILD_DIR=$1
ENV_DIR=$3

# curl -O -L http://downloads.sourceforge.net/sourceforge/pcre/pcre-8.34.tar.gz
curl -O -L http://openresty.org/download/openresty-1.13.6.1.tar.gz 
# tar xzf pcre-8.34.tar.gz
tar -xvf openresty-1.13.6.1.tar.gz 
cd openresty-1.13.6.1
./configure -j2  --with-pcre-jit --with-luajit
make -j2
make install
export PATH=/sbin:$PATH
# ./configure --prefix=/app/openresty --with-pcre=/app/pcre-8.34 --with-luajit --with-file-aio --with-ipv6 --with-http_realip_module --with-http_addition_module --with-http_xslt_module --with-http_sub_module --with-http_dav_module --with-http_flv_module --with-http_gzip_static_module --with-http_random_index_module --with-http_secure_link_module --with-http_degradation_module --with-http_stub_status_module --with-mail --with-mail_ssl_module --with-pcre-jit --with-http_iconv_module -j2
make
make install
# cd
# tar czf openresty_build-1.5.11.1-1.tar.gz openresty

# PKG="https://github.com/davidad/heroku-buildpack-openresty/releases/download/v1.5.11.1-1/openresty_build-1.5.11.1-1.tar.gz"

echo "-----> Unpacking $PKG..."
curl -L $PKG | tar xzf - -C $BUILD_DIR
mkdir -p $BUILD_DIR/conf/env/vars
cp $ENV_DIR/* $BUILD_DIR/conf/env/vars

if [ ! -r $BUILD_DIR/Procfile ]; then
  if [ ! -r $BUILD_DIR/start.sh ]; then
    cat > $BUILD_DIR/start.sh <<'EOF'
#!/bin/sh
mkdir -p logs
touch logs/error.log
touch logs/access.log
echo "listen $PORT;" > conf/env/heroku-http-port
openresty/nginx/sbin/nginx -p `pwd`/ -c conf/openresty.conf
EOF
    chmod +x $BUILD_DIR/start.sh
  fi
  echo '       No Procfile; using start.sh'
  echo 'web: ./start.sh' > $BUILD_DIR/Procfile
fi
