#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3


topic() {
  echo "-----> $*"
}


build_from_binary() {
	topic "Downlaoding package"
	PKG="https://github.com/alex-kaufman/heroku-buildpack-openresty/releases/download/v1.13.6.1/openresty_build-1.13.6.1.tar.gz"

	topic "Unpacking $PKG..."
	curl -L $PKG | tar xzf - -C $BUILD_DIR
}

rebuild_from_source() {
	sh build/build.sh $1 $2 $3
}

build_from_binary

mkdir -p $BUILD_DIR/conf/env/vars
cp $ENV_DIR/* $BUILD_DIR/conf/env/vars

if [ ! -r $BUILD_DIR/Procfile ]; then
  if [ ! -r $BUILD_DIR/start.sh ]; then
    cat > $BUILD_DIR/start.sh <<'EOF'
#!/bin/sh
mkdir -p logs
touch logs/error.log
touch logs/access.log
echo "listen $PORT;" > conf/env/heroku-http-port
.heroku/nginx/sbin/nginx -p `pwd`/ -c conf/openresty.conf
EOF
    chmod +x $BUILD_DIR/start.sh
  fi
  topic '       No Procfile; using start.sh'
  echo 'web: ./start.sh' > $BUILD_DIR/Procfile
fi
